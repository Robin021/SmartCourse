{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/robin/VSCode/SmartCourse/proxy.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport type { NextRequest } from \"next/server\";\nimport { jwtVerify } from \"jose\";\n\nexport async function proxy(request: NextRequest) {\n    const token = request.cookies.get(\"token\")?.value;\n    const { pathname } = request.nextUrl;\n\n    const redirectToLogin = () => {\n        const url = request.nextUrl.clone();\n        url.pathname = \"/login\";\n        const res = NextResponse.redirect(url);\n        res.cookies.delete(\"token\");\n        return res;\n    };\n\n    // Public paths that don't require auth\n    const publicPaths = [\"/login\", \"/api/auth/login\", \"/api/auth/register\", \"/api/seed\", \"/api/auth/me\"];\n    const isPublicPath = publicPaths.some((path) => pathname.startsWith(path));\n\n    // Basic token check\n    if (!token && !isPublicPath) {\n        return redirectToLogin();\n    }\n    if (token && token.split(\".\").length !== 3) {\n        return redirectToLogin();\n    }\n\n    // Redirect authenticated users away from login\n    if (token && pathname === \"/login\") {\n        const url = request.nextUrl.clone();\n        url.pathname = \"/\";\n        return NextResponse.redirect(url);\n    }\n\n    // Admin check\n    if (pathname.startsWith(\"/admin\") || pathname.startsWith(\"/api/admin\")) {\n        if (!token) {\n            return redirectToLogin();\n        }\n\n        try {\n            const secret = new TextEncoder().encode(\n                process.env.JWT_SECRET || \"dev-secret-key\"\n            );\n            const { payload } = await jwtVerify(token, secret);\n\n            if (payload.role !== \"SYSTEM_ADMIN\") {\n                const url = request.nextUrl.clone();\n                url.pathname = \"/\";\n                return NextResponse.redirect(url);\n            }\n        } catch (error) {\n            console.warn(\"Proxy Auth Error:\", error instanceof Error ? error.message : error);\n            return redirectToLogin();\n        }\n    }\n\n    return NextResponse.next();\n}\n\nexport const config = {\n    matcher: [\n        \"/((?!_next/static|_next/image|favicon.ico).*)\",\n    ],\n};\n\nexport default proxy;\n"],"names":[],"mappings":";;;;;;;;AAAA;AAEA;;;AAEO,eAAe,MAAM,OAAoB;IAC5C,MAAM,QAAQ,QAAQ,OAAO,CAAC,GAAG,CAAC,UAAU;IAC5C,MAAM,EAAE,QAAQ,EAAE,GAAG,QAAQ,OAAO;IAEpC,MAAM,kBAAkB;QACpB,MAAM,MAAM,QAAQ,OAAO,CAAC,KAAK;QACjC,IAAI,QAAQ,GAAG;QACf,MAAM,MAAM,8IAAY,CAAC,QAAQ,CAAC;QAClC,IAAI,OAAO,CAAC,MAAM,CAAC;QACnB,OAAO;IACX;IAEA,uCAAuC;IACvC,MAAM,cAAc;QAAC;QAAU;QAAmB;QAAsB;QAAa;KAAe;IACpG,MAAM,eAAe,YAAY,IAAI,CAAC,CAAC,OAAS,SAAS,UAAU,CAAC;IAEpE,oBAAoB;IACpB,IAAI,CAAC,SAAS,CAAC,cAAc;QACzB,OAAO;IACX;IACA,IAAI,SAAS,MAAM,KAAK,CAAC,KAAK,MAAM,KAAK,GAAG;QACxC,OAAO;IACX;IAEA,+CAA+C;IAC/C,IAAI,SAAS,aAAa,UAAU;QAChC,MAAM,MAAM,QAAQ,OAAO,CAAC,KAAK;QACjC,IAAI,QAAQ,GAAG;QACf,OAAO,8IAAY,CAAC,QAAQ,CAAC;IACjC;IAEA,cAAc;IACd,IAAI,SAAS,UAAU,CAAC,aAAa,SAAS,UAAU,CAAC,eAAe;QACpE,IAAI,CAAC,OAAO;YACR,OAAO;QACX;QAEA,IAAI;YACA,MAAM,SAAS,IAAI,cAAc,MAAM,CACnC,QAAQ,GAAG,CAAC,UAAU,IAAI;YAE9B,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,oKAAS,EAAC,OAAO;YAE3C,IAAI,QAAQ,IAAI,KAAK,gBAAgB;gBACjC,MAAM,MAAM,QAAQ,OAAO,CAAC,KAAK;gBACjC,IAAI,QAAQ,GAAG;gBACf,OAAO,8IAAY,CAAC,QAAQ,CAAC;YACjC;QACJ,EAAE,OAAO,OAAO;YACZ,QAAQ,IAAI,CAAC,qBAAqB,iBAAiB,QAAQ,MAAM,OAAO,GAAG;YAC3E,OAAO;QACX;IACJ;IAEA,OAAO,8IAAY,CAAC,IAAI;AAC5B;AAEO,MAAM,SAAS;IAClB,SAAS;QACL;KACH;AACL;uCAEe"}}]
}